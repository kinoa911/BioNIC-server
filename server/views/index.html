<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In</title>
    <link href="/css/main.css" rel="stylesheet">
</head>

<body>
    <h1 class="title">BIONIC</h1>
    <div id="svg">
        <div id="svgsvg">
            <svg version="1.1" id="Icons" viewBox="0 0 32 32" xml:space="preserve"
                sodipodi:docname="security-protection-shield-user-svgrepo-com.svg"
                inkscape:version="1.3 (0e150ed6c4, 2023-07-21)"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg"
                xmlns:svg="http://www.w3.org/2000/svg">
                <defs id="defs2"></defs>
                <sodipodi:namedview id="namedview2" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25"
                    inkscape:showpageshadow="2" inkscape:pageopacity="0.0" inkscape:pagecheckerboard="0"
                    inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="17.964932" inkscape:cx="12.051257"
                    inkscape:cy="12.162585" inkscape:window-width="1920" inkscape:window-height="1009"
                    inkscape:window-x="-8" inkscape:window-y="-8" inkscape:window-maximized="1"
                    inkscape:current-layer="Icons"></sodipodi:namedview>
                <path class="st0 TUkLaPlD_0"
                    d="M25,6.7c-3.4,0-6.6-1.4-9-3.7c-2.4,2.3-5.6,3.7-9,3.7C5.6,6.7,4.3,6.4,3,6c0,14,5.5,19.6,13,23  c7.5-3.4,13-9,13-23C27.7,6.4,26.4,6.7,25,6.7z"
                    id="path1" style="stroke: rgb(127, 194, 17); stroke-opacity: 1; stroke-width: 1.99937;"></path>
                <path class="st0 TUkLaPlD_1" id="circle1"
                    style="stroke: rgb(239, 239, 240); stroke-width: 1.99937; stroke-opacity: 1;"
                    d="M12,13A4,4 0,1,1 20,13A4,4 0,1,1 12,13"></path>
                <path class="st0 TUkLaPlD_2" d="M 8.3,23.6 C 10.1,21.4 12.9,20 16,20 c 3.1,0 5.9,1.4 7.7,3.6" id="path2"
                    style="stroke: rgb(239, 239, 240); stroke-width: 1.99937; stroke-opacity: 1;"></path>
            </svg>
        </div>

        <div id="svgfailed" hidden>
            <svg version="1.1" id="Icons" viewBox="0 0 32 32" xml:space="preserve"
                sodipodi:docname="security-protection-shield-padlock-svgrepo-com (1).svg"
                inkscape:version="1.3 (0e150ed6c4, 2023-07-21)"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg"
                xmlns:svg="http://www.w3.org/2000/svg" style="">
                <defs id="defs3"></defs>
                <sodipodi:namedview id="namedview3" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25"
                    inkscape:showpageshadow="2" inkscape:pageopacity="0.0" inkscape:pagecheckerboard="0"
                    inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="17.964932" inkscape:cx="9.1567284"
                    inkscape:cy="13.943833" inkscape:window-width="1920" inkscape:window-height="1009"
                    inkscape:window-x="-8" inkscape:window-y="-8" inkscape:window-maximized="1"
                    inkscape:current-layer="Icons"></sodipodi:namedview>
                <path class="st0 XVrrgQfx_0"
                    d="M25,6.7c-3.4,0-6.6-1.4-9-3.7c-2.4,2.3-5.6,3.7-9,3.7C5.6,6.7,4.3,6.4,3,6c0,14,5.5,19.6,13,23  c7.5-3.4,13-9,13-23C27.7,6.4,26.4,6.7,25,6.7z"
                    id="path1" style="stroke:#c22f25;stroke-opacity:1"
                    inkscape:export-filename="..\Desktop\svg_locked.svg" inkscape:export-xdpi="1755.4286"
                    inkscape:export-ydpi="1755.4286"></path>
                <path class="st0 XVrrgQfx_1"
                    d="M19,22h-6c-1.1,0-2-0.9-2-2v-4c0-1.1,0.9-2,2-2h6c1.1,0,2,0.9,2,2v4C21,21.1,20.1,22,19,22z"
                    id="path2" style="stroke:#85858d;stroke-opacity:1"></path>
                <path class="st0 XVrrgQfx_2" d="M20,14h-8v-2c0-2.2,1.8-4,4-4h0c2.2,0,4,1.8,4,4V14z" id="path3"
                    style="stroke:#85858d;stroke-opacity:1"></path>
                <path class="st0 XVrrgQfx_3" id="line3" style="stroke:#85858d;stroke-opacity:1" d="M16,17L16,19"></path>
            </svg>
        </div>
        <p id="status"></p>
    </div>
    
    <footer>
        <p>Powered by</p>
        <img src="/logo/logo.png" class="logo" alt="Pockit Logo">
    </footer>

    <p id="action" hidden><%=action%></p>
    <p id="username" hidden><%=username%></p>
    <p id="displayname" hidden><%=displayname%></p>

</body>

<script>
    let msgid = 0;
    let _username = document.getElementById("username").textContent;
    let _displayname = document.getElementById("displayname").textContent;

    function log(status) {
        msgid++;
        document.getElementById("status").innerHTML = status;
    }

    if (_username) {
        if (window.PublicKeyCredential) {

            log("🔗" + document.referrer);
            setTimeout(() => {
                go();
            }, 1500);
        } else {
            log("⛔ Device not supported");
            failed();
        }
    }

    function success() {
        document.getElementById("status").innerHTML = `✅ Success! Redirecting...<div class="loading"></div>`;
        setTimeout(() => {
            window.open(document.referrer + "success", "_parent");
        }, 3000);
    }

    function failed() {
        document.getElementById("svgsvg").hidden = true;
        document.getElementById("svgfailed").hidden = false;
        setTimeout(() => {
            window.open(document.referrer + "success", "_parent");
        }, 3500);
    }

    function go() {
        log("🔍 Identifying you...");
        var challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);
        var userID = 'Kosv9fPtkDoh4Oz7Yq/pVgWHS8HhdlCto5cR0aBoVMw='
        var id = Uint8Array.from(window.atob(userID), c => c.charCodeAt(0))

        var publicKey = {
            challenge: challenge,

            allowCredentials: [{
                type: "public-key",
                id: id
            }]
        }

        var publicKey = {
            'challenge': challenge,

            'rp': {
                'name': 'Localhost',
                //'id': 'localhost'
                'id': 'werewolf-polite-broadly.ngrok-free.app'
            },

            'user': {
                'id': id,
                'name': _username,
                'displayName': _displayname
            },

            'pubKeyCredParams': [{
                    'type': 'public-key',
                    'alg': -7
                },
                {
                    'type': 'public-key',
                    'alg': -257
                }
            ],
        }

        log('document.getElementById("action").innerHTML:');
        console.log('document.getElementById("action")', document.getElementById("action"));

        if (document.getElementById("action").innerHTML == "login") login();
        // if (document.getElementById("action").innerHTML == "signup")
            signup();

        function login() {
            log("login");

            navigator.credentials.get({
                    'publicKey': publicKey
                })
                .then((getAssertionResponse) => {
                    const str = new TextDecoder().decode(getAssertionResponse.response.authenticatorData);
                    const byteArray = new TextEncoder().encode(str);
                    const buffer = byteArray.buffer;

                    console.log(getAssertionResponse)
                    console.log("authenticator data", new TextDecoder().decode(getAssertionResponse.response
                        .authenticatorData))
                    console.log("cdjson", JSON.parse(new TextDecoder().decode((getAssertionResponse.response
                        .clientDataJSON))))
                    console.log("signature", new TextDecoder().decode((getAssertionResponse.response.signature)))
                    console.log("user handle", new TextDecoder().decode((getAssertionResponse.response.userHandle)))
                    success();
                })
                .catch((error) => {
                    log("⛔ Failed to identify you!<br>Redirecting...")
                    failed();
                })
        }

        function signup() {
            log("signup");

            navigator.credentials.create({
                    'publicKey': publicKey
                })
                .then((newCredentialInfo) => {
                    var e = new TextEncoder();
                    console.log(newCredentialInfo)
                    console.log("rawid", btoa(newCredentialInfo.rawId))

                    console.log("credential info", (newCredentialInfo))

                    console.log(newCredentialInfo.response.getAuthenticatorData())
                    console.log(newCredentialInfo.response.getPublicKey());
                    console.log(newCredentialInfo.response.getPublicKeyAlgorithm());
                    console.log(newCredentialInfo.response.getTransports());
                    console.log(newCredentialInfo.response.clientDataJSON);
                    success();
                })
                .catch((error) => {
                    log("⛔ Failed to identify you!<br>Redirecting...")
                    failed();
                    console.log("create error", error)
                })
        }

    }
</script>

</html>